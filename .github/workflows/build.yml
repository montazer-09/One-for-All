name: ğŸš€ SmartTools Hub - Production Build

on:
  workflow_dispatch: # ØªØ´ØºÙŠÙ„ ÙŠØ¯ÙˆÙŠ

jobs:
  build_and_sign:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: â˜• Setup Java JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: ğŸŒ Create Web Assets (Full App Code)
        run: |
          mkdir -p www
          # Ù‡Ù†Ø§ ÙŠØªÙ… ÙˆØ¶Ø¹ ÙƒÙˆØ¯ HTML Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚
          cat > www/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="ar" dir="rtl">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
              <meta name="theme-color" content="#0a0a0f">
              <title>SmartTools Hub</title>
              <style>
                  :root {
                      --bg-app: #0a0a0f; --bg-panel: #12121a; --bg-btn: #252532;
                      --accent: #00d4ff; --danger: #ef4444; --text-main: #ffffff;
                      --nav-height: 70px; --header-height: 55px; --banner-height: 60px;
                      --safe-bottom: env(safe-area-inset-bottom, 20px);
                  }
                  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; outline: none; margin: 0; padding: 0; }
                  body {
                      background: var(--bg-app); color: var(--text-main);
                      font-family: -apple-system, BlinkMacSystemFont, "Tajawal", sans-serif;
                      height: 100vh; height: 100dvh; display: flex; flex-direction: column; overflow: hidden;
                  }
                  /* BANNER FIX: Z-INDEX 2000 ensures it stays on top */
                  #banner-ad-container {
                      position: fixed; bottom: calc(var(--nav-height) + var(--safe-bottom)); left: 0;
                      width: 100%; height: var(--banner-height); background: var(--bg-panel);
                      border-top: 1px solid rgba(255,255,255,0.05); z-index: 2000;
                      display: flex; align-items: center; justify-content: center; font-size: 0.75rem; color: #666;
                  }
                  #viewport { flex: 1; position: relative; overflow: hidden; display: flex; flex-direction: column; margin-bottom: calc(var(--banner-height)); }
                  .page { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-app); display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.35s ease; z-index: 10; overflow: hidden; }
                  .page.active { transform: translateX(0); z-index: 20; }
                  .header { flex: 0 0 var(--header-height); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; background: linear-gradient(180deg, rgba(18,18,26,0.98), rgba(18,18,26,0.9)); border-bottom: 1px solid rgba(255,255,255,0.05); }
                  .content { flex: 1; overflow-y: auto; padding: 15px; }
                  #navbar { flex: 0 0 calc(var(--nav-height) + var(--safe-bottom)); background: linear-gradient(180deg, rgba(10,10,15,0.98), rgba(10,10,15,1)); border-top: 1px solid rgba(255,255,255,0.05); display: grid; grid-template-columns: repeat(5, 1fr); padding-bottom: var(--safe-bottom); z-index: 100; }
                  .nav-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #6b7280; font-size: 9px; background: transparent; border: none; gap: 4px; }
                  .nav-btn.active { color: var(--accent); }
                  .nav-icon { font-size: 22px; }
                  /* Calculator Styles */
                  #calc-display { flex: 0 0 32%; display: flex; flex-direction: column; justify-content: flex-end; align-items: flex-end; padding: 20px; }
                  #result-line { font-size: 3.5rem; color: #fff; width: 100%; text-align: left; background: transparent; border: none; direction: ltr; }
                  #calc-keypad { flex: 1; background: var(--bg-panel); border-radius: 28px 28px 0 0; padding: 18px; display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(5, 1fr); gap: 12px; }
                  .key { background: var(--bg-btn); color: #fff; border: none; border-radius: 16px; font-size: 1.4rem; display: flex; align-items: center; justify-content: center; }
                  .key.op { background: #ff6b35; color: #000; } .key.equals { background: var(--accent); color: #000; }
                  input, select, textarea { width: 100%; background: var(--bg-btn); border: 1px solid rgba(255,255,255,0.05); padding: 14px; border-radius: 12px; color: #fff; margin-bottom: 10px; }
                  .card { background: #1a1a25; padding: 18px; border-radius: 20px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.03); }
                  #sci-pad { position: absolute; bottom: 0; left: 0; width: 100%; height: 65%; background: rgba(18,18,26,0.98); backdrop-filter: blur(30px); border-radius: 28px 28px 0 0; padding: 20px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; transform: translateY(110%); transition: transform 0.35s ease; z-index: 50; }
                  #sci-pad.visible { transform: translateY(0); }
                  /* Features Grid */
                  .feature-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
                  .feature-btn { background: #1a1a25; border: 1px solid rgba(255,255,255,0.05); border-radius: 16px; padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; }
                  /* Modal */
                  .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; align-items: flex-end; justify-content: center; z-index: 200; backdrop-filter: blur(10px); }
                  .modal-overlay.active { display: flex; }
                  .modal-content { background: var(--bg-panel); width: 100%; max-height: 85%; border-radius: 28px 28px 0 0; padding: 25px; transform: translateY(100%); transition: transform 0.3s ease; overflow-y: auto; }
                  .modal-overlay.active .modal-content { transform: translateY(0); }
                  /* Toast */
                  #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 3000; }
                  .toast { background: #1a1a25; padding: 14px 20px; border-radius: 14px; color: #fff; margin-bottom: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); }
              </style>
          </head>
          <body>
              <div id="banner-ad-container"></div>
              <div id="toast-container"></div>
              <div id="modal-overlay" class="modal-overlay" onclick="Modal.close(event)">
                  <div class="modal-content" onclick="event.stopPropagation()">
                      <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                          <h3 id="modal-title"></h3><button onclick="Modal.close()" style="background:none;border:none;color:#fff;font-size:1.2rem;">âœ•</button>
                      </div>
                      <div id="modal-body"></div>
                  </div>
              </div>
              <div id="viewport">
                  <!-- Calc Page -->
                  <div id="page-calc" class="page active">
                      <div id="calc-display">
                          <div style="width:100%; display:flex; justify-content:space-between;"><span id="mode-indicator" style="color:var(--accent)">RAD</span><span onclick="App.toggleSci()" style="color:#888">â‹®</span></div>
                          <div id="history-line"></div><input type="text" id="result-line" value="0" readonly>
                      </div>
                      <div id="calc-keypad">
                          <button class="key ac" onclick="Calc.input('AC', 'ac')">AC</button><button class="key ac" onclick="Calc.input('DEL', 'del')">âŒ«</button><button class="key ac" onclick="Calc.input('%', 'op')">%</button><button class="key op" onclick="Calc.input('/', 'op')">Ã·</button>
                          <button class="key" onclick="Calc.input('7')">7</button><button class="key" onclick="Calc.input('8')">8</button><button class="key" onclick="Calc.input('9')">9</button><button class="key op" onclick="Calc.input('*', 'op')">Ã—</button>
                          <button class="key" onclick="Calc.input('4')">4</button><button class="key" onclick="Calc.input('5')">5</button><button class="key" onclick="Calc.input('6')">6</button><button class="key op" onclick="Calc.input('-', 'op')">âˆ’</button>
                          <button class="key" onclick="Calc.input('1')">1</button><button class="key" onclick="Calc.input('2')">2</button><button class="key" onclick="Calc.input('3')">3</button><button class="key op" onclick="Calc.input('+', 'op')">+</button>
                          <button class="key" onclick="App.toggleSci()">SCI</button><button class="key" onclick="Calc.input('0')">0</button><button class="key" onclick="Calc.input('.')">.</button><button class="key equals" onclick="Calc.solve()">=</button>
                      </div>
                      <div id="sci-pad">
                          <button class="key" onclick="Calc.input('sin(','fn')">sin</button><button class="key" onclick="Calc.input('cos(','fn')">cos</button><button class="key" onclick="Calc.input('tan(','fn')">tan</button><button class="key" onclick="Calc.toggleMode()">DEG</button>
                          <button class="key" onclick="Calc.input('sqrt(','fn')">âˆš</button><button class="key" onclick="Calc.input('^','op')">^</button><button class="key" onclick="Calc.input('log(','fn')">log</button><button class="key" onclick="Calc.input('ln(','fn')">ln</button>
                          <button class="key" onclick="Calc.input('(','fn')">(</button><button class="key" onclick="Calc.input(')','fn')">)</button><button class="key" onclick="Calc.input('pi','const')">Ï€</button><button class="key" onclick="Calc.input('e','const')">e</button>
                      </div>
                  </div>
                  <!-- Features Page -->
                  <div id="page-features" class="page">
                      <div class="header"><span>Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª</span></div>
                      <div class="content">
                          <div class="feature-grid">
                              <div class="feature-btn" onclick="Features.open('currency')"><span>ğŸ’±</span><span>Ø¹Ù…Ù„Ø§Øª</span></div>
                              <div class="feature-btn" onclick="Features.open('loan')"><span>ğŸ¦</span><span>Ù‚Ø±ÙˆØ¶</span></div>
                              <div class="feature-btn" onclick="Features.open('bmi')"><span>âš–ï¸</span><span>BMI</span></div>
                              <div class="feature-btn" onclick="Features.open('password')"><span>ğŸ”</span><span>ÙƒÙ„Ù…Ø§Øª Ù…Ø±ÙˆØ±</span></div>
                              <div class="feature-btn" onclick="Features.open('qr')"><span>ğŸ“±</span><span>QR</span></div>
                              <div class="feature-btn" onclick="Features.open('date')"><span>ğŸ“…</span><span>ØªØ§Ø±ÙŠØ®</span></div>
                              <div class="feature-btn" onclick="Features.open('discount')"><span>ğŸ·ï¸</span><span>Ø®ØµÙ…</span></div>
                              <div class="feature-btn" onclick="Features.open('tip')"><span>ğŸ’°</span><span>Ø¨Ù‚Ø´ÙŠØ´</span></div>
                          </div>
                      </div>
                  </div>
                  <!-- Tools Page -->
                  <div id="page-tools" class="page">
                      <div class="header"><span>Ø£Ø¯ÙˆØ§Øª</span></div>
                      <div class="content">
                          <div class="card">
                              <h3>Ù…Ø­ÙˆÙ„ ÙˆØ­Ø¯Ø§Øª</h3>
                              <select id="conv-type" onchange="Tools.update()"><option value="len">Ø·ÙˆÙ„</option><option value="mass">ÙˆØ²Ù†</option></select>
                              <div style="display:flex;gap:10px;margin-top:10px"><input type="number" id="conv-in" oninput="Tools.convert()"><input type="text" id="conv-out" readonly></div>
                          </div>
                          <div class="card"><h3>Ù…ÙÙƒØ±Ø©</h3><textarea id="notepad" rows="5" oninput="localStorage.setItem('note',this.value)"></textarea></div>
                      </div>
                  </div>
                  <!-- Settings Page -->
                  <div id="page-setup" class="page">
                      <div class="header"><span>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span></div>
                      <div class="content">
                          <div class="card">
                              <div style="padding:10px 0">Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª <input type="checkbox" checked onclick="Ads.toggleBanner()"></div>
                              <button onclick="localStorage.clear();location.reload()" style="width:100%;padding:10px;background:#ef4444;border:none;color:#fff;border-radius:10px;margin-top:10px">Ø¶Ø¨Ø· Ø§Ù„Ù…ØµÙ†Ø¹</button>
                          </div>
                      </div>
                  </div>
              </div>
              <nav id="navbar">
                  <button class="nav-btn active" onclick="App.nav('calc',this)"><span>ğŸ§®</span><span>Ø­Ø§Ø³Ø¨Ø©</span></button>
                  <button class="nav-btn" onclick="App.nav('features',this)"><span>âœ¨</span><span>Ù…Ù…ÙŠØ²Ø§Øª</span></button>
                  <button class="nav-btn" onclick="App.nav('tools',this)"><span>ğŸ› ï¸</span><span>Ø£Ø¯ÙˆØ§Øª</span></button>
                  <button class="nav-btn" onclick="App.nav('setup',this)"><span>âš™ï¸</span><span>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span></button>
              </nav>
              <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
              <script>
                  const Ads = {
                      initialized: false, visible: true,
                      init: () => {
                          if(typeof UnityAdsAndroid !== 'undefined') {
                              try {
                                  UnityAdsAndroid.initialize('6043972', false);
                                  Ads.initialized = true;
                                  setTimeout(()=>Ads.showBanner(), 1000); 
                              } catch(e){}
                          }
                      },
                      showBanner: () => {
                          if(typeof UnityAdsAndroid !== 'undefined' && Ads.visible) {
                              UnityAdsAndroid.showBanner('Banner_Android');
                          }
                      },
                      showRewarded: () => {
                          if(typeof UnityAdsAndroid !== 'undefined') UnityAdsAndroid.showRewarded('Rewarded_Android');
                      },
                      toggleBanner: () => {
                          Ads.visible = !Ads.visible;
                          if(Ads.visible) Ads.showBanner();
                          else document.getElementById('banner-ad-container').style.display = 'none';
                      }
                  };
                  const App = {
                      init: () => {
                          if(localStorage.getItem('note')) document.getElementById('notepad').value = localStorage.getItem('note');
                          Ads.init(); Tools.update();
                      },
                      nav: (p,b) => {
                          document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
                          document.getElementById('page-'+p).classList.add('active');
                          document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
                          b.classList.add('active');
                      },
                      toggleSci: () => document.getElementById('sci-pad').classList.toggle('visible')
                  };
                  const Calc = {
                      str: '0', ang: 'rad',
                      input: (v,t) => {
                          if(t=='ac') Calc.str='0'; else if(t=='del') Calc.str=Calc.str.slice(0,-1)||'0';
                          else Calc.str=Calc.str=='0'?v:Calc.str+v;
                          document.getElementById('result-line').value=Calc.str;
                      },
                      solve: () => {
                          try {
                              let e = Calc.str.replace('^','**').replace('pi','Math.PI').replace('e','Math.E').replace('sqrt','Math.sqrt');
                              e = Calc.ang=='deg' ? e.replace(/sin\(([^)]+)\)/g, 'Math.sin($1*Math.PI/180)') : e.replace('sin','Math.sin');
                              document.getElementById('result-line').value = Calc.str = String(eval(e)).slice(0,12);
                          } catch { Calc.str='Error'; }
                      },
                      toggleMode: () => { Calc.ang=Calc.ang=='rad'?'deg':'rad'; document.getElementById('mode-indicator').innerText=Calc.ang.toUpperCase(); }
                  };
                  const Tools = {
                      data: {len:{m:1,km:0.001}, mass:{kg:1,g:1000}},
                      update: () => { /* Simplified update logic */ },
                      convert: () => { /* Simplified convert logic */ }
                  };
                  const Features = {
                      open: (f) => {
                          if(['currency','loan'].includes(f)) Ads.showRewarded();
                          document.getElementById('modal-overlay').classList.add('active');
                          document.getElementById('modal-title').innerText = f.toUpperCase();
                          document.getElementById('modal-body').innerHTML = '<p style="text-align:center;padding:20px">Feature Active</p>';
                      }
                  };
                  const Modal = { close: (e) => { if(!e || e.target.id=='modal-overlay') document.getElementById('modal-overlay').classList.remove('active'); }};
                  window.onload = App.init;
              </script>
          </body>
          </html>
          EOF
          echo "âœ… index.html created successfully"

      - name: ğŸ“¦ Initialize Capacitor Project (SmartTools Hub)
        run: |
          cat > package.json << 'EOF'
          {
            "name": "smarttools-hub",
            "version": "1.0.0",
            "dependencies": {
              "@capacitor/android": "^6.0.0",
              "@capacitor/core": "^6.0.0",
              "@capacitor/cli": "^6.0.0"
            }
          }
          EOF
          npm install
          # ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø³Ù… SmartTools Hub ÙˆØ§Ù„Ø¨Ø§ÙƒØ¬ com.smarttools.hub.app
          npx cap init "SmartTools Hub" "com.smarttools.hub.app" --web-dir www
          npx cap add android
          echo "âœ… Capacitor Initialized for SmartTools Hub"

      - name: âš™ï¸ Configure Java & Permissions
        run: |
          echo "org.gradle.java.home=${JAVA_HOME_21_X64}" >> android/gradle.properties
          sed -i 's/JavaVersion.VERSION_17/JavaVersion.VERSION_21/g' android/app/build.gradle
          sed -i 's/JavaVersion.VERSION_1_8/JavaVersion.VERSION_21/g' android/app/build.gradle
          sed -i '/<application/i \    <uses-permission android:name="android.permission.INTERNET" />' android/app/src/main/AndroidManifest.xml
          sed -i '/<application/i \    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />' android/app/src/main/AndroidManifest.xml

      - name: ğŸ’‰ Add Unity Ads SDK & Native Code
        run: |
          # Add SDK Dependency
          sed -i '/dependencies {/a \    implementation "com.unity3d.ads:unity-ads:4.12.0"' android/app/build.gradle
          
          # Create Plugin Directory (Matching new package name)
          mkdir -p android/app/src/main/java/com/smarttools/hub/app/plugins

          # UnityAdsPlugin.java
          cat > android/app/src/main/java/com/smarttools/hub/app/plugins/UnityAdsPlugin.java << 'EOF'
          package com.smarttools.hub.app.plugins;
          import android.app.Activity;
          import android.webkit.JavascriptInterface;
          import android.webkit.WebView;
          import com.unity3d.ads.*;
          import android.util.Log;

          public class UnityAdsPlugin {
              private Activity activity;
              private WebView webView;
              public UnityAdsPlugin(Activity activity, WebView webView) { this.activity = activity; this.webView = webView; }

              @JavascriptInterface
              public void initialize(String gameId, boolean testMode) {
                  activity.runOnUiThread(() -> {
                      UnityAds.initialize(activity, gameId, testMode, new IUnityAdsInitializationListener() {
                          @Override public void onInitializationComplete() {
                              // Call showBanner immediately after init to ensure visibility
                              webView.evaluateJavascript("window.UnityAdsCallback && window.UnityAdsCallback('initialized', {success: true})", null);
                          }
                          @Override public void onInitializationFailed(UnityAds.UnityAdsInitializationError e, String m) {}
                      });
                  });
              }

              @JavascriptInterface
              public void showBanner(String placementId) {
                  activity.runOnUiThread(() -> {
                      UnityAds.load(placementId, new IUnityAdsLoadListener() {
                          @Override public void onUnityAdsAdLoaded(String pid) { 
                              UnityAds.show(activity, pid, new UnityAdsShowOptions(), new IUnityAdsShowListener() {
                                  @Override public void onUnityAdsShowFailure(String p, UnityAds.UnityAdsShowError e, String m) {}
                                  @Override public void onUnityAdsShowStart(String p) {}
                                  @Override public void onUnityAdsShowClick(String p) {}
                                  @Override public void onUnityAdsShowComplete(String p, UnityAds.UnityAdsShowCompletionState s) {}
                              }); 
                          }
                          @Override public void onUnityAdsFailedToLoad(String pid, UnityAds.UnityAdsLoadError e, String m) {}
                      });
                  });
              }

              @JavascriptInterface
              public void showRewarded(String placementId) {
                  activity.runOnUiThread(() -> {
                      UnityAds.load(placementId, new IUnityAdsLoadListener() {
                          @Override public void onUnityAdsAdLoaded(String pid) { UnityAds.show(activity, pid); }
                          @Override public void onUnityAdsFailedToLoad(String pid, UnityAds.UnityAdsLoadError e, String m) {}
                      });
                  });
              }
          }
          EOF

          # MainActivity.java (Matching new package name)
          cat > android/app/src/main/java/com/smarttools/hub/app/MainActivity.java << 'EOF'
          package com.smarttools.hub.app;
          import android.os.Bundle;
          import com.getcapacitor.BridgeActivity;
          import com.smarttools.hub.app.plugins.UnityAdsPlugin;

          public class MainActivity extends BridgeActivity {
              @Override public void onCreate(Bundle savedInstanceState) {
                  super.onCreate(savedInstanceState);
                  if (getBridge() != null && getBridge().getWebView() != null) {
                      getBridge().getWebView().addJavascriptInterface(new UnityAdsPlugin(this, getBridge().getWebView()), "UnityAdsAndroid");
                  }
              }
          }
          EOF

      - name: ğŸ”¨ Build Release APK
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleRelease -Dorg.gradle.java.home=${JAVA_HOME_21_X64}

      - name: ğŸ” Sign Production APK
        uses: r0adkll/sign-android-release@v1
        id: sign_app
        with:
          releaseDirectory: android/app/build/outputs/apk/release
          signingKeyBase64: ${{ secrets.SIGNING_KEY }}
          alias: ${{ secrets.KEY_ALIAS }}
          keyStorePassword: ${{ secrets.KEY_STORE_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}
          buildToolsVersion: 34.0.0

      - name: ğŸ“¤ Upload Signed Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SmartTools-Hub-Signed-Release
          path: ${{ steps.sign_app.outputs.signedReleaseFile }}
          retention-days: 30