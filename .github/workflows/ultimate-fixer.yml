name: Ultimate Self-Healing CI

on:
  push:
    branches: [ "main", "master" ]
  pull_request:

permissions:
  contents: write  # ╪╡┘Д╪з╪н┘К╪й ╪з┘Д┘Г╪к╪з╪и╪й ┘Д┘Д┘Е╪│╪к┘И╪п╪╣

jobs:
  build-and-heal:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # ╪м┘Д╪и ╪з┘Д╪к╪з╪▒┘К╪о ┘Г╪з┘Е┘Д╪з┘Л ┘Д╪к╪м┘Ж╪и ┘Е╪┤╪з┘Г┘Д ╪з┘Д┘А Push

    - name: Set up Environment (Auto-Detect)
      run: |
        # ╪к╪л╪и┘К╪к ╪и╪з┘К╪л┘И┘Ж ┘Д╪к╪┤╪║┘К┘Д ╪з┘Д╪│┘Г╪▒┘К╪и╪к ╪з┘Д╪о╪з╪╡ ╪и┘Ж╪з
        sudo apt-get update
        sudo apt-get install -y python3-pip
        pip3 install requests

    - name: Set up Java (For Android)
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Attempt Build (Universal)
      id: build_attempt
      # ┘З┘Ж╪з ╪з┘Д╪г┘И╪з┘Е╪▒ ╪з┘Д╪к┘К ╪к╪н╪з┘И┘Д ╪з┘Д╪и┘Ж╪з╪б╪М ╪е╪░╪з ┘Б╪┤┘Д╪к ┘К╪к┘Е ╪н┘Б╪╕ ╪з┘Д╪о╪╖╪г ┘И┘Д╪з ┘К╪к┘И┘В┘Б ╪з┘Д╪│┘Г╪▒┘К╪и╪к
      run: |
        echo "ЁЯЪА Starting Build..."
        
        # ╪╣╪п┘Д ┘З╪░╪з ╪з┘Д╪│╪╖╪▒ ╪н╪│╪и ┘Ж┘И╪╣ ┘Е╪┤╪▒┘И╪╣┘Г (┘Е╪л╪з┘Д ┘Д┘Д╪г┘Ж╪п╪▒┘И┘К╪п)
        chmod +x gradlew
        ./gradlew assembleDebug > build_error.log 2>&1 || echo "BUILD_FAILED=true" >> $GITHUB_ENV

    - name: ЁЯЪС Activate AI Agent
      if: env.BUILD_FAILED == 'true'
      env:
        KIMI_API_KEY: ${{ secrets.KIMI_API_KEY }}
        MY_ACCESS_TOKEN: ${{ secrets.MY_ACCESS_TOKEN }} # ╪з┘Д╪к┘И┘Г┘Ж ╪з┘Д╪о╪з╪╡ ╪и┘Г
      run: |
        echo "тЪая╕П Build Failed! Summoning Kimi Agent..."
        python3 .github/scripts/ai_agent.py
        
