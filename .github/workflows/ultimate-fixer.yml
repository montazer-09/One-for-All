name: Ultimate Self-Healing CI

on:
  push:
    branches: [ "main", "master" ]
  pull_request:

permissions:
  contents: write  # ╪╡┘Д╪з╪н┘К╪й ╪з┘Д┘Г╪к╪з╪и╪й ┘Д┘Д┘Е╪│╪к┘И╪п╪╣

jobs:
  build-and-heal:
    runs-on: ubuntu-latest
    
        steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Environment
      run: |
        sudo apt-get update
        pip3 install requests

    - name: Attempt Build (Universal & Resilient)
      id: build_step
      # "continue-on-error" ╪к╪╢┘Е┘Ж ╪г┘Ж ╪з┘Д┘А Workflow ┘Д┘Ж ┘К╪к┘И┘В┘Б ┘З┘Ж╪з ╪и┘Д ╪│┘К┘Г┘Е┘Д ┘Д┘Д┘И┘Г┘К┘Д
      continue-on-error: true 
      run: |
        echo "ЁЯЪА Starting Universal Build Discovery..."
        {
          # ┘Е╪н╪з┘И┘Д╪й ╪з┘Д╪к╪╣╪▒┘Б ╪╣┘Д┘Й ┘Ж┘И╪╣ ╪з┘Д┘Е╪┤╪▒┘И╪╣ ┘И╪к╪┤╪║┘К┘Д┘З
          if [ -f "gradlew" ]; then
            chmod +x gradlew && ./gradlew assembleDebug
          elif [ -f "package.json" ]; then
            npm install && npm run build
          elif [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          else
            # ╪е╪░╪з ┘Д┘Е ┘К╪м╪п ╪┤┘К╪ж╪з┘Л╪М ╪│┘К┘Б╪к╪╣┘Д ╪о╪╖╪г ┘Д┘К┘В┘И┘Е ╪з┘Д┘И┘Г┘К┘Д ╪и╪к╪н┘Д┘К┘Д ╪з┘Д┘Е╪│╪к┘И╪п╪╣
            echo "Error: No build system (Gradle/NPM/Pip) detected in root!"
            exit 1
          fi
        } > build_error.log 2>&1

    - name: ЁЯЪС Activate AI Agent
      # ┘З╪░╪з ╪з┘Д╪┤╪▒╪╖ ┘К╪╢┘Е┘Ж ╪╣┘Е┘Д ╪з┘Д┘И┘Г┘К┘Д ╪е╪░╪з ┘Б╪┤┘Д╪к ╪з┘Д╪о╪╖┘И╪й ╪з┘Д╪│╪з╪и┘В╪й ┘Д╪г┘К ╪│╪и╪и ┘Г╪з┘Ж
      if: steps.build_step.outcome == 'failure'
      env:
        KIMI_API_KEY: ${{ secrets.KIMI_API_KEY }}
        MY_ACCESS_TOKEN: ${{ secrets.MY_ACCESS_TOKEN }}
      run: |
        echo "тЪая╕П Failure detected. Summoning AI Agent to investigate..."
        python3 .github/scripts/ai_agent.py
        
