name: OMNI-OS PRO - Unity Ads Production Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Java JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Prepare Web Assets
        run: |
          mkdir -p www
          cp index.html www/
          echo "âœ… Assets prepared"

      - name: Initialize Package.json
        run: |
          cat > package.json << 'EOF'
          {
            "name": "SmartTools Hub",
            "version": "1.0.0",
            "description": "SmartTools Hub - Production Ready",
            "scripts": {
              "build": "echo 'Build ready'"
            },
            "dependencies": {
              "@capacitor/android": "^6.0.0",
              "@capacitor/core": "^6.0.0",
              "@capacitor/cli": "^6.0.0"
            }
          }
          EOF
          echo "âœ… Package.json created"

      - name: Install Dependencies
        run: |
          npm install
          echo "âœ… Dependencies installed"

      - name: Initialize Capacitor Project
        run: |
          rm -rf android
          npx cap init "SmartTools Hub" "com.SmartTools.Hub.app" --web-dir www
          npx cap add android
          echo "âœ… Capacitor initialized"

      - name: Configure Java 21
        run: |
          echo "org.gradle.java.home=${JAVA_HOME_21_X64}" >> android/gradle.properties
          echo "android.useAndroidX=true" >> android/gradle.properties
          echo "android.enableJetifier=true" >> android/gradle.properties
          echo "âœ… Gradle properties configured"

      - name: Update Build Gradle for Java 21
        run: |
          sed -i 's/JavaVersion.VERSION_17/JavaVersion.VERSION_21/g' android/app/build.gradle
          sed -i 's/JavaVersion.VERSION_1_8/JavaVersion.VERSION_21/g' android/app/build.gradle
          echo "âœ… Build gradle updated"

      - name: Add Unity Ads SDK
        run: |
          # Add Unity Ads dependency to build.gradle
          sed -i '/dependencies {/a \    implementation "com.unity3d.ads:unity-ads:4.12.0"' android/app/build.gradle
          echo "âœ… Unity Ads SDK added"

      - name: Configure Android Permissions
        run: |
          # Add required permissions to AndroidManifest.xml
          sed -i '/<application/i \    <uses-permission android:name="android.permission.INTERNET" />' android/app/src/main/AndroidManifest.xml
          sed -i '/<application/i \    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />' android/app/src/main/AndroidManifest.xml
          echo "âœ… Permissions configured"

      - name: Create Unity Ads Bridge Plugin
        run: |
          mkdir -p android/app/src/main/java/com/omni/pro/app/plugins

          cat > android/app/src/main/java/com/omni/pro/app/plugins/UnityAdsPlugin.java << 'EOF'
          package com.omni.pro.app.plugins;

          import android.app.Activity;
          import android.webkit.JavascriptInterface;
          import android.webkit.WebView;
          import com.unity3d.ads.IUnityAdsInitializationListener;
          import com.unity3d.ads.IUnityAdsLoadListener;
          import com.unity3d.ads.IUnityAdsShowListener;
          import com.unity3d.ads.UnityAds;
          import com.unity3d.ads.UnityAdsShowOptions;
          import android.util.Log;

          public class UnityAdsPlugin {
              private static final String TAG = "UnityAdsPlugin";
              private Activity activity;
              private WebView webView;

              public UnityAdsPlugin(Activity activity, WebView webView) {
                  this.activity = activity;
                  this.webView = webView;
              }

              @JavascriptInterface
              public void initialize(String gameId, boolean testMode) {
                  Log.d(TAG, "Initializing Unity Ads: " + gameId);
                  activity.runOnUiThread(() -> {
                      UnityAds.initialize(activity, gameId, testMode, new IUnityAdsInitializationListener() {
                          @Override
                          public void onInitializationComplete() {
                              Log.d(TAG, "Unity Ads initialized successfully");
                              executeJS("window.UnityAdsCallback && window.UnityAdsCallback('initialized', {success: true})");
                          }

                          @Override
                          public void onInitializationFailed(UnityAds.UnityAdsInitializationError error, String message) {
                              Log.e(TAG, "Unity Ads initialization failed: " + message);
                              executeJS("window.UnityAdsCallback && window.UnityAdsCallback('initialized', {success: false, error: '" + message + "'})");
                          }
                      });
                  });
              }

              @JavascriptInterface
              public void showBanner(String placementId) {
                  Log.d(TAG, "Show Banner: " + placementId);
                  activity.runOnUiThread(() -> {
                      UnityAds.load(placementId, new IUnityAdsLoadListener() {
                          @Override
                          public void onUnityAdsAdLoaded(String placementId) {
                              UnityAds.show(activity, placementId, new UnityAdsShowOptions(), new IUnityAdsShowListener() {
                                  @Override
                                  public void onUnityAdsShowFailure(String placementId, UnityAds.UnityAdsShowError error, String message) {
                                      Log.e(TAG, "Banner show failed: " + message);
                                  }

                                  @Override
                                  public void onUnityAdsShowStart(String placementId) {
                                      Log.d(TAG, "Banner started");
                                  }

                                  @Override
                                  public void onUnityAdsShowClick(String placementId) {
                                      Log.d(TAG, "Banner clicked");
                                  }

                                  @Override
                                  public void onUnityAdsShowComplete(String placementId, UnityAds.UnityAdsShowCompletionState state) {
                                      Log.d(TAG, "Banner complete");
                                  }
                              });
                          }

                          @Override
                          public void onUnityAdsFailedToLoad(String placementId, UnityAds.UnityAdsLoadError error, String message) {
                              Log.e(TAG, "Banner load failed: " + message);
                          }
                      });
                  });
              }

              @JavascriptInterface
              public void showInterstitial(String placementId) {
                  Log.d(TAG, "Show Interstitial: " + placementId);
                  activity.runOnUiThread(() -> {
                      UnityAds.load(placementId, new IUnityAdsLoadListener() {
                          @Override
                          public void onUnityAdsAdLoaded(String placementId) {
                              UnityAds.show(activity, placementId);
                          }

                          @Override
                          public void onUnityAdsFailedToLoad(String placementId, UnityAds.UnityAdsLoadError error, String message) {
                              Log.e(TAG, "Interstitial load failed: " + message);
                          }
                      });
                  });
              }

              @JavascriptInterface
              public void showRewarded(String placementId) {
                  Log.d(TAG, "Show Rewarded: " + placementId);
                  activity.runOnUiThread(() -> {
                      UnityAds.load(placementId, new IUnityAdsLoadListener() {
                          @Override
                          public void onUnityAdsAdLoaded(String placementId) {
                              UnityAds.show(activity, placementId, new UnityAdsShowOptions(), new IUnityAdsShowListener() {
                                  @Override
                                  public void onUnityAdsShowFailure(String placementId, UnityAds.UnityAdsShowError error, String message) {
                                      Log.e(TAG, "Rewarded show failed: " + message);
                                  }

                                  @Override
                                  public void onUnityAdsShowStart(String placementId) {
                                      Log.d(TAG, "Rewarded started");
                                  }

                                  @Override
                                  public void onUnityAdsShowClick(String placementId) {
                                      Log.d(TAG, "Rewarded clicked");
                                  }

                                  @Override
                                  public void onUnityAdsShowComplete(String placementId, UnityAds.UnityAdsShowCompletionState state) {
                                      Log.d(TAG, "Rewarded complete");
                                      executeJS("window.UnityAdsCallback && window.UnityAdsCallback('rewarded', {success: true})");
                                  }
                              });
                          }

                          @Override
                          public void onUnityAdsFailedToLoad(String placementId, UnityAds.UnityAdsLoadError error, String message) {
                              Log.e(TAG, "Rewarded load failed: " + message);
                          }
                      });
                  });
              }

              private void executeJS(String js) {
                  activity.runOnUiThread(() -> webView.evaluateJavascript(js, null));
              }
          }
          EOF
          echo "âœ… Unity Ads Plugin created"

      - name: Integrate Plugin with MainActivity
        run: |
          # Update MainActivity to include the plugin
          cat > android/app/src/main/java/com/omni/pro/app/MainActivity.java << 'EOF'
          package com.omni.pro.app;

          import android.os.Bundle;
          import com.getcapacitor.BridgeActivity;
          import com.getcapacitor.Bridge;
          import com.omni.pro.app.plugins.UnityAdsPlugin;

          public class MainActivity extends BridgeActivity {
              @Override
              public void onCreate(Bundle savedInstanceState) {
                  super.onCreate(savedInstanceState);

                  Bridge bridge = this.getBridge();
                  if (bridge != null && bridge.getWebView() != null) {
                      UnityAdsPlugin unityAdsPlugin = new UnityAdsPlugin(this, bridge.getWebView());
                      bridge.getWebView().addJavascriptInterface(unityAdsPlugin, "UnityAdsAndroid");
                  }
              }
          }
          EOF
          echo "âœ… MainActivity updated"

      - name: Sync Capacitor
        run: |
          npx cap sync android
          echo "âœ… Capacitor synced"

      - name: Build APK
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleRelease -Dorg.gradle.java.home=${JAVA_HOME_21_X64} --stacktrace
          echo "âœ… APK built successfully"

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: SmartTools Hub
          path: android/app/build/outputs/apk/release/app-release.apk
          retention-days: 30

      - name: Build Summary
        run: |
          echo "ðŸŽ‰ Build completed successfully!"
          echo "ðŸ“± APK ready for testing"
          echo "ðŸŽ® Unity Ads SDK: v4.12.0"
          echo "â˜• Java: 21"
          echo "âš¡ Capacitor: 6.x"
          
